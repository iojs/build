---
- hosts: iojs-www

  remote_user: root

  tasks:
    - include_vars: ansible-vars.yaml
      tags: vars

    ### configure machine and core packages

    - name: General | APT Update
      apt: update_cache=yes
      tags: general

    - name: General | APT Upgrade
      apt: upgrade=full
      tags: general

    - name: Node.js | Add the NodeSource Node.js repo
      command: "bash -c 'curl -sL https://deb.nodesource.com/setup | bash -'"
      tags: node

    - name: General | Install required packages
      apt: name={{ item }} update_cache=yes state=latest
      with_items: packages
      tags: general

    ### setup the users

    - name: User | Add system users
      user: name="{{ item }}" shell=/bin/bash
      with_items:
        - "{{ server_user }}"
        - "{{ staging_user }}"
        - "{{ dist_user }}"
      tags: user

    - name: User | Download pubkey(s)
      get_url: url=https://github.com/{{ item }}.keys dest=/tmp/{{ item }}.keys
      delegate_to: 127.0.0.1
      with_items: ssh_users
      tags: user

    - name: General | Create authorized_keys for root
      authorized_key: user="root" key="{{ lookup('file', '/tmp/' + item + '.keys') }}"
      with_items: ssh_users
      tags: user

    - name: General | authorized_keys for users
      authorized_key: user="{{ item[0] }}" key="{{ lookup('file', '/tmp/' + item[1] + '.keys') }}"
      with_nested:
        - [ '{{ dist_user }}', '{{ server_user }}', '{{ staging_user }}' ]
        - ssh_users
      tags: user

    - name: General | place ssh keys
      copy: owner="{{ item[0] }}" group="{{ item[0] }}" src=resources/keys/{{ item[0] }}/{{ item[1].name }} dest=/home/{{ item[0] }}/.ssh/{{ item[1].name }} mode={{item[1].perms}}
      with_nested:
        - [ "{{ dist_user }}", "{{ staging_user }}" ]
        - [ { name: 'id_rsa', perms: '0600' }, { name: 'id_rsa.pub', perms: '0644' } ]

    - name: General | add id_rsa.pub to staging, dist authorized_keys
      authorized_key: user="{{ item }}" key="{{ lookup('file', 'resources/keys/' + item + '/id_rsa.pub') }}"
      with_items:
        [ "{{ staging_user }}", "{{ dist_user }}" ]
      tags: user

    ### setup git and git webhooks

    - name: GitHub Webhook | Install github-webhook
      command: "npm install github-webhook -g"
      tags: webhook

    - name: GitHub Webhook | Copy config
      copy: src=resources/github-webhook.json dest=/etc/github-webhook.json mode=0644
      tags: webhook

    - name: GitHub Webhook | Copy secret to config
      replace: dest=/etc/github-webhook.json regexp="\{\{github_secret\}\}" replace="{{ github_secret }}"
      tags: webhook

    - name: GitHub Webhook | Copy update command to config
      replace: dest=/etc/github-webhook.json regexp="\{\{update_command\}\}" replace="{{ update_command }}"
      tags: webhook

    - name: GitHub Webhook | Copy Upstart config
      copy: src=resources/github-webhook.conf dest=/etc/init/github-webhook.conf mode=0644
      tags: webhook

    - name: GitHub Webhook | Start service
      service: name=github-webhook state=started
      tags: webhook

    - name: Setup | Initial clone
      remote_user: "{{ server_user }}"
      command: "bash -c '{{ clone_command }}'"
      tags: setup

    - name: Setup | Initial update
      remote_user: "{{ server_user }}"
      command: "bash -c '{{ update_command }}'"
      tags: setup

    ### configure cron and utility capabilities

    - name: Configure | setup download-stats script
      copy: src=../../dist/update-download-stats.sh dest="/home/{{ server_user }}" mode=0755
      tags: setup

    - name: Configure | setup dist-indexer directory
      file: path="/home/{{ dist_user }}/dist-indexer" state=directory
      tags: setup

    - name: Configure | setup dist-indexer
      copy: src="../../dist/dist-indexer/{{ item.name }}" dest="/home/{{ dist_user }}/dist-indexer/{{ item.name }}" mode={{ item.perms }}
      with_items:
        - [ { name: 'package.json', perms: '0644' }, { name: 'dist-indexer.js', perms: '0755' } ]

    - name: Configure | npm install for dist-indexer
      command: npm install chdir="/home/{{ dist_user }}/dist-indexer"
      tags: setup

    - name: Configure | setup cron for nightly
      cron: name="promote_nightly" minute="*/5" job="/home/staging/promote/promote_nightly.sh" user="{{ dist_user }}"
      tags: setup

    - name: Configure | setup cron for download-stats
      cron: name="update_download_stats" minute="30" hour="1" job="/home/iojs/update-download-stats.sh" user="root"
      tags: setup

    ### configure nginx

    - name: nginx | Copy site config
      copy: src=resources/iojs.org dest=/etc/nginx/sites-available/iojs.org mode=0644
      tags: nginx

    - name: nginx | Create config symlink
      file: src=/etc/nginx/sites-available/iojs.org dest=/etc/nginx/sites-enabled/00-iojs.org state=link
      tags: nginx

    - name: nginx | Creates ssl directory
      file: path=/etc/nginx/ssl/ state=directory
      tags: nginx

    - name: nginx | Generate DH params
      command: openssl dhparam -out /etc/nginx/ssl/dhparam.pem 4096 creates=/etc/nginx/ssl/dhparam.pem
      tags: nginx

    - name: nginx | Copy site certificates
      copy: src=resources/{{ item }} dest=/etc/nginx/ssl/{{ item }} mode=0644
      with_items:
        - iojs_chained.crt
        - iojs.key
      tags: nginx

    - name: nginx | Delete default config
      file: path=/etc/nginx/sites-enabled/default state=absent
      tags: nginx

    - name: nginx | Add .pkg mime-type
      lineinfile: dest=/etc/nginx/mime.types line='application/octet-stream pkg;' insertafter='^types.*'
      tags: nginx

    - name: nginx | Add .xz mime-type
      lineinfile: dest=/etc/nginx/mime.types line='application/x-xz xz;' insertafter='^types.*'
      tags: nginx

    - name: nginx | Use official .gz mime-type
      lineinfile: dest=/etc/nginx/mime.types line='application/gzip gz;' insertafter='^types.*'
      tags: nginx

    - name: nginx | Restart service
      service: name=nginx state=restarted
      tags: webhook
