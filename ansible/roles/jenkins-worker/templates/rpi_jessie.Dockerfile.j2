FROM resin/rpi-raspbian:jessie

ENV LC_ALL C
ENV USER {{ server_user }}
ENV JOBS {{ jobs_env }}
ENV SHELL /bin/bash
ENV HOME /home/{{ server_user }}
ENV PATH /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
ENV NODE_COMMON_PIPE /home/{{ server_user }}/test.pipe
ENV NODE_TEST_DIR /home/{{ server_user }}/tmp
ENV OSTYPE linux-gnu
ENV OSVARIANT docker
ENV DESTCPU {{ arch }}
ENV ARCH {{ arch }}

RUN apt-get update && apt-get dist-upgrade -y && apt-get install -y \
      g++-4.9 \
      gcc-4.9 \
      git \
      make \
      zlib1g \
      zlib1g-dev \
      python2.7 \
      python \
      curl && \
    apt-get clean -y && \
    rm -rf /var/lib/apt/lists/*

RUN update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.9 50 && \
    update-alternatives --install /usr/bin/c++ c++ /usr/bin/g++-4.9 50 && \
    update-alternatives --install /usr/bin/cpp cpp /usr/bin/gcc-4.9 50 && \
    update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.9 50 && \
    update-alternatives --install /usr/bin/cc cc /usr/bin/gcc-4.9 50

RUN addgroup \
      --gid {{ server_user_gid.stdout_lines[0] }} \
      {{ server_user }} && \
    adduser \
      --gid {{ server_user_gid.stdout_lines[0] }} \
      --uid {{ server_user_uid.stdout_lines[0] }} \
      --disabled-password \
      --gecos {{ server_user }} \
      {{ server_user }}

RUN curl -sL https://www.samba.org/ftp/ccache/ccache-{{ ccache_latest }}.tar.gz | tar zxv -C /tmp/ && \
    cd /tmp/ccache-{{ ccache_latest }} && \
    ./configure && \
    make -j {{ jobs_env }} && \
    install -c -m 755 ccache /usr/local/bin && \
    ln -s /usr/local/bin/ccache /usr/local/bin/gcc && \
    ln -s /usr/local/bin/ccache /usr/local/bin/cc && \
    ln -s /usr/local/bin/ccache /usr/local/bin/g++ && \
    ln -s /usr/local/bin/ccache /usr/local/bin/c++ && \
    ln -s /usr/local/bin/ccache /usr/local/bin/cpp && \
    rm -rf /tmp/ccache-{{ ccache_latest }}

VOLUME /home/{{ server_user }}/

USER iojs:iojs

ENV CCACHE_TEMPDIR /home/{{ server_user }}/.ccache/{{ inventory_hostname }}

ENTRYPOINT [ "tail", "-f", "/dev/null" ]
